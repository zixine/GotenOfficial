name: Build GKI BoltX-6.1 (KowSU+SUSFS- Full Fix

on:
  workflow_dispatch:
    inputs:
      # Input 'kernel_name' sudah dihapus karena branding sudah otomatis
      clang_version:
        description: 'Versi Clang'
        required: true
        default: 'r536225 (Clang 19)'
        type: choice
        options:
        - 'r536225 (Clang 19)'
        - 'r547379 (Clang 20)'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04

    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Install Dependencies
        run: |
          apt-get update
          # FIX: Tambahkan 'dwarves' (untuk pahole) dan 'libelf-dev'
          apt-get install -y build-essential bc bison flex libssl-dev git curl \
          python3 python3-pip lld zip unzip libncurses5-dev rsync \
          cpio schedtool git-core gnupg libelf-dev dwarves

      - name: Setup Repo Tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git config --global url."https://".insteadOf git://

      - name: Initialize & Sync Source (GKI 6.1)
        run: |
          mkdir gki
          cd gki
          repo init --depth=1 -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1
          repo sync -j$(nproc) --force-sync

      - name: Setup Custom Clang
        working-directory: gki
        run: |
          mkdir -p toolchain/clang
          
          if [ "${{ github.event.inputs.clang_version }}" == "r536225 (Clang 19)" ]; then
            echo "Setting up Clang-19 (r536225)..."
            CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main-kernel-2025/clang-r536225.tar.gz"
          else
            echo "Setting up Clang-20 (r547379)..."
            CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/62cdcefa89e31af2d72c366e8b5ef8db84caea62/clang-r547379.tar.gz"
          fi
          
          echo "Downloading Clang..."
          curl -L "${CLANG_URL}" | tar -xz -C toolchain/clang

      - name: Patch KernelSU (Official)
        working-directory: gki/common
        run: |
          echo "Setting up KowSUxSF.."
          curl -LSs "https://raw.githubusercontent.com/KOWX712/KernelSU/refs/heads/staging/kernel/setup.sh" | bash -

      - name: Patch SuSFS (Manual + Fix Conflict)
        working-directory: gki/common
        run: |
          echo "Cloning SUSFS Patches (Branch: gki-android14-6.1)..."
          git clone https://gitlab.com/simonpunk/susfs4ksu/ -b gki-android14-6.1 sus_temp
          
          cp -r sus_temp/kernel_patches/fs/* fs/
          cp -r sus_temp/kernel_patches/include/* include/
          cp sus_temp/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch .
          
          echo "Applying SUSFS Patch..."
          patch -p1 < 50_add_susfs_in_gki-android14-6.1.patch || true
          
          echo "Fixing fs/proc/base.c conflict..."
          grep -q "linux/susfs.h" fs/proc/base.c || sed -i '/#include <linux\/fs.h>/a #include <linux/susfs.h>' fs/proc/base.c
          
          rm -rf sus_temp 50_add_susfs_in_gki-android14-6.1.patch fs/proc/base.c.rej

      - name: Configure Kernel
        working-directory: gki/common
        run: |
          export PATH="$(pwd)/../toolchain/clang/bin:$PATH"
          export ARCH=arm64
          export LLVM=1
          
          echo "Generating GKI defconfig..."
          make O=out gki_defconfig

          # --- Inject KSU & SuSFS Config ---
          cat <<EOF >> out/.config
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_SU=y
          CONFIG_KSU_SUSFS_SUS_KSTAT_SPOOF_GENERIC=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSTAT=y
          EOF

          # --- Logic Nama Kernel (TIDAK LAGI OPSIONAL) ---
          # Branding kernel langsung diatur ke nama yang diinginkan
          echo "Setting kernel branding to -BoltX-KowSUxSF-V1"
          scripts/config --file out/.config --set-str LOCALVERSION "-BoltX-KowSUxSF-V1"

          # --- LTO Config ---
          echo "Configuring LTO..."
          scripts/config --file out/.config \
              -e LTO_CLANG \
              -d LTO_NONE \
              -e LTO_CLANG_THIN \
              -d LTO_CLANG_FULL \
              -e THINLTO

      - name: Build Kernel Image
        working-directory: gki/common
        run: |
          export PATH="$(pwd)/../toolchain/clang/bin:$PATH"
          export ARCH=arm64
          export LLVM=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_COMPAT=arm-linux-gnueabi-
          
          echo "Starting Build..."
          make -j"$(nproc --all)" O=out Image

      - name: Determine Artifact Name
        id: artifact-name
        run: |
          # Nama artifact juga disesuaikan dengan branding kernel
          echo "NAME=BoltX-KowSUxSF-V1-Image" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.NAME }}
          path: gki/common/out/arch/arm64/boot/Image
          compression-level: 9